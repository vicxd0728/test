<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç«æ˜Ÿæ¥­å‹™å“¡ï¼šå¥§å®¢æ”»é˜²æˆ°</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;900&family=Press+Start+2P&display=swap');

        :root {
            --bg-color: #1a1a2e;
            --panel-bg: #16213e;
            --accent-green: #00ff88;
            --accent-red: #ff4d4d;
            --accent-yellow: #f9d71c;
            --text-color: #e94560;
        }

        body {
            margin: 0;
            background-color: #000;
            color: white;
            font-family: 'Noto Sans TC', sans-serif;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            user-select: none;
        }

        #game-boy {
            width: 100%;
            max-width: 480px;
            height: 100%;
            max-height: 800px;
            background: var(--bg-color);
            position: relative;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 2px solid #333;
        }

        /* --- æˆ°é¬¥ç•«é¢ --- */
        .battle-stage {
            flex: 2;
            background: linear-gradient(180deg, #2c3e50 0%, #000000 100%);
            position: relative;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        /* æ•µäººå€ */
        .enemy-zone {
            text-align: center;
            margin-top: 20px;
            position: relative;
        }

        .enemy-sprite {
            font-size: 100px;
            filter: drop-shadow(0 10px 10px rgba(0,0,0,0.5));
            animation: float 3s ease-in-out infinite;
            display: inline-block;
        }

        .enemy-speech {
            position: absolute;
            top: -20px;
            right: 10px;
            background: #fff;
            color: #000;
            padding: 10px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            max-width: 150px;
            box-shadow: 2px 2px 0 #000;
            opacity: 0;
            transform: scale(0);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .enemy-speech.show { opacity: 1; transform: scale(1); }
        .enemy-speech::after {
            content: ''; position: absolute; bottom: -10px; left: 20px;
            border-width: 10px 10px 0; border-style: solid;
            border-color: #fff transparent; display: block; width: 0;
        }

        /* ç©å®¶å€ */
        .player-zone {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            padding-bottom: 10px;
        }

        .player-sprite {
            font-size: 80px;
            transform: scaleX(-1); /* é¢å°å³é‚Š */
            filter: drop-shadow(0 5px 5px rgba(0,255,136,0.3));
        }

        /* ç‹€æ…‹æ¢ (è¡€æ¢) */
        .status-box {
            background: rgba(0,0,0,0.6);
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #555;
            width: 45%;
        }
        
        .name-tag { font-size: 14px; font-weight: bold; margin-bottom: 4px; display: flex; justify-content: space-between;}
        
        .bar-container {
            width: 100%; height: 12px;
            background: #333; border-radius: 6px; overflow: hidden;
            border: 1px solid #fff;
        }
        .bar-fill { height: 100%; width: 100%; transition: width 0.3s; }
        
        .hp-bar { background: linear-gradient(90deg, #ff4d4d, #ff0000); }
        .sanity-bar { background: linear-gradient(90deg, #00f3ff, #0066ff); } /* ç©å®¶ç†æ™ºç·š */
        .shield-bar { height: 4px; background: #f9d71c; width: 0%; margin-top: 2px; }

        /* --- æ§åˆ¶é¢æ¿ --- */
        .control-panel {
            flex: 1.5;
            background: var(--panel-bg);
            padding: 15px;
            display: flex;
            flex-direction: column;
            border-top: 4px solid #000;
        }

        /* è¨Šæ¯è¦–çª— */
        .message-log {
            background: #000;
            color: #00ff88;
            font-family: 'Noto Sans TC', monospace;
            padding: 10px;
            height: 60px;
            border-radius: 5px;
            border: 2px solid #444;
            margin-bottom: 10px;
            font-size: 14px;
            line-height: 1.4;
            overflow: hidden;
        }

        /* æŠ€èƒ½æŒ‰éˆ•å€ */
        .skill-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            flex: 1;
        }

        .skill-btn {
            background: #2a2a2a;
            color: #fff;
            border: none;
            border-bottom: 4px solid #111;
            border-radius: 8px;
            padding: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            position: relative;
            transition: all 0.1s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .skill-btn:active:not(:disabled) {
            transform: translateY(4px);
            border-bottom-width: 0;
        }

        .skill-btn:disabled {
            opacity: 0.5;
            filter: grayscale(1);
            cursor: not-allowed;
        }

        .skill-cost {
            font-size: 10px;
            color: var(--accent-yellow);
            margin-top: 4px;
        }

        /* AP é»æ•¸ */
        .ap-display {
            position: absolute;
            top: -15px; left: 50%; transform: translateX(-50%);
            background: #000;
            color: var(--accent-yellow);
            padding: 5px 15px;
            border-radius: 20px;
            border: 2px solid var(--accent-yellow);
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 4px 0 rgba(0,0,0,0.5);
        }

        /* --- è¦–è¦ºç‰¹æ•ˆ --- */
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        
        .damage-text {
            position: absolute;
            font-weight: 900;
            font-size: 30px;
            color: #ff0000;
            text-shadow: 2px 2px 0 #fff;
            animation: popUp 0.8s forwards;
            pointer-events: none;
            z-index: 20;
        }
        @keyframes popUp { 0% { transform: translateY(0) scale(0.5); opacity: 0; } 20% { transform: translateY(-20px) scale(1.5); opacity: 1; } 100% { transform: translateY(-50px) scale(1); opacity: 0; } }

        .shake-screen { animation: shake 0.3s; }
        @keyframes shake { 0% { transform: translate(0,0); } 25% { transform: translate(-5px, 5px); } 75% { transform: translate(5px, -5px); } 100% { transform: translate(0,0); } }

        /* å…¨è¢å¹•é®ç½© (é–‹å§‹/çµæŸ/å‡ç´š) */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }
        .hidden { display: none; }

        h1 { font-size: 32px; margin-bottom: 10px; color: var(--accent-green); }
        .btn-main {
            background: var(--accent-red); color: white; border: none; padding: 15px 40px;
            font-size: 20px; font-weight: bold; border-radius: 50px; cursor: pointer;
            margin-top: 20px; box-shadow: 0 0 20px rgba(255, 77, 77, 0.5);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        .card-container { display: grid; gap: 10px; width: 100%; }
        .upgrade-card {
            background: #222; border: 2px solid #444; padding: 15px; border-radius: 10px;
            cursor: pointer; text-align: left; transition: all 0.2s;
        }
        .upgrade-card:hover { border-color: var(--accent-green); background: #333; }
        .card-title { color: var(--accent-green); font-weight: bold; font-size: 16px; margin-bottom: 5px; }
        .card-desc { color: #aaa; font-size: 12px; }

    </style>
</head>
<body>

<div id="game-boy">
    
    <!-- æˆ°é¬¥å€åŸŸ -->
    <div class="battle-stage" id="battleStage">
        <!-- æ•µäººå€ -->
        <div class="enemy-zone">
            <div id="enemyBubble" class="enemy-speech">å¤ªè²´äº†ï¼ç®—ä¾¿å®œé»ï¼</div>
            <div id="enemySprite" class="enemy-sprite">ğŸ‘¿</div>
            <div style="position:absolute; bottom: -60px; right: 0; width: 100%;">
                <div class="status-box" style="margin: 0 auto;">
                    <div class="name-tag">
                        <span id="enemyName">å¥§å®¢</span>
                        <span id="enemyHpText">100/100</span>
                    </div>
                    <div class="bar-container"><div id="enemyHpBar" class="bar-fill hp-bar"></div></div>
                    <div style="text-align:right; font-size:10px; color:#aaa; margin-top:2px;">(é˜²å‚™å¿ƒ)</div>
                </div>
            </div>
        </div>

        <!-- ç©å®¶å€ -->
        <div class="player-zone">
            <div class="status-box">
                <div class="name-tag">
                    <span>ğŸ‘½ æˆ‘æ–¹æ¥­å‹™</span>
                    <span id="playerHpText">100/100</span>
                </div>
                <div class="bar-container"><div id="playerHpBar" class="bar-fill sanity-bar"></div></div>
                <div id="playerShieldBar" class="shield-bar"></div>
                <div style="text-align:left; font-size:10px; color:#aaa; margin-top:2px;">(ç†æ™ºç·š)</div>
            </div>
            <div class="player-sprite" id="playerSprite">ğŸ‘½</div>
        </div>
    </div>

    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="control-panel">
        <div class="ap-display">âš¡ AP: <span id="playerAp">3</span>/3</div>
        <div class="message-log" id="msgLog">æˆ°é¬¥é–‹å§‹ï¼å¥§å®¢å‡ºç¾äº†ï¼</div>
        
        <div class="skill-grid" id="skillGrid">
            <button class="skill-btn" onclick="useSkill('attack')">
                ğŸ”¥ å¼·åŠ›æ¨éŠ·
                <span class="skill-cost">1 AP | æ”» 15-20</span>
            </button>
            <button class="skill-btn" onclick="useSkill('defend')">
                ğŸ›¡ï¸ æ•·è¡å‡ç¬‘
                <span class="skill-cost">1 AP | é˜² +15</span>
            </button>
            <button class="skill-btn" onclick="useSkill('heal')">
                â˜• å–å’–å•¡æ‘¸é­š
                <span class="skill-cost">2 AP | å›è¡€ +25</span>
            </button>
            <button class="skill-btn" onclick="useSkill('ultimate')">
                ğŸ’ è·³æ¨“å¤§æ‹è³£
                <span class="skill-cost">3 AP | æ”» 40+</span>
            </button>
        </div>
    </div>

    <!-- ä»‹é¢é®ç½© -->
    <!-- 1. é–‹å§‹ç•«é¢ -->
    <div id="startScreen" class="overlay">
        <h1>ç«æ˜Ÿæ¥­å‹™å“¡<br>å¥§å®¢æ”»é˜²æˆ°</h1>
        <div style="font-size:60px; margin:20px;">ğŸ‘½ vs ğŸ‘¹</div>
        <p style="color:#ccc; font-size:14px; line-height:1.6;">
            ç›®æ¨™ï¼šè³ºå¤  1000 è¬ç«æ˜Ÿå¹£è²·ç¥¨å›å®¶ã€‚<br>
            ç©æ³•ï¼šæ‰“ç ´å¥§å®¢çš„ã€Œé˜²å‚™å¿ƒã€ç°½ä¸‹è¨‚å–®ã€‚<br>
            æ³¨æ„ï¼šä½ çš„ã€Œç†æ™ºç·šã€æ­¸é›¶å°±é›¢è·äº†ï¼
        </p>
        <button class="btn-main" onclick="startGame()">é–‹å§‹æ¥å–®</button>
    </div>

    <!-- 2. å‡ç´šç•«é¢ -->
    <div id="upgradeScreen" class="overlay hidden">
        <h1 style="color:#f9d71c">ç°½ç´„æˆåŠŸï¼</h1>
        <p style="color:#fff; margin-bottom:20px;">ç²å¾—æ¥­ç¸¾çé‡‘ï¼Œè«‹é¸æ“‡å¼·åŒ–é …ç›®ï¼š</p>
        <div class="card-container">
            <div class="upgrade-card" onclick="applyUpgrade('atk')">
                <div class="card-title">ğŸ”¥ è©±è¡“å‡ç´š</div>
                <div class="card-desc">æ¨éŠ·å‚·å®³ +5 (åŸºç¤æ”»æ“ŠåŠ›æå‡)</div>
            </div>
            <div class="upgrade-card" onclick="applyUpgrade('hp')">
                <div class="card-title">ğŸ§  å¼·åŒ–ç»ç’ƒå¿ƒ</div>
                <div class="card-desc">ç†æ™ºä¸Šé™ +20 & å›æ»¿è¡€</div>
            </div>
            <div class="upgrade-card" onclick="applyUpgrade('ap')">
                <div class="card-title">âš¡ èƒ½é‡é£²æ–™</div>
                <div class="card-desc">æˆ°é¬¥é–‹å§‹æ™‚é¡å¤–ç²å¾— 1 AP</div>
            </div>
        </div>
    </div>

    <!-- 3. çµæŸç•«é¢ -->
    <div id="endScreen" class="overlay hidden">
        <h1 id="endTitle" style="color:#ff4d4d">ä½ é›¢è·äº†...</h1>
        <p id="endReason" style="color:#ccc">ç†æ™ºç·šæ–·è£‚</p>
        <div style="font-size:40px; margin:20px;">ğŸ’€</div>
        <button class="btn-main" onclick="resetGame()">é‡æ–°é¢è©¦</button>
    </div>

    <!-- 4. å…¨ç ´ç•«é¢ -->
    <div id="victoryScreen" class="overlay hidden">
        <h1 style="color:#00ff88">å…‰æ¦®è¿”é„‰ï¼</h1>
        <p>ä½ æˆç‚ºäº†å‚³èªªä¸­çš„é‡‘ç‰Œæ¥­å‹™ï¼<br>ç«æ˜Ÿé£›èˆ¹å·²ç¶“æº–å‚™å¥½èµ·é£›äº†ã€‚</p>
        <div style="font-size:60px; margin:20px;">ğŸš€</div>
        <button class="btn-main" onclick="resetGame()">å†æ¬¡æŒ‘æˆ°</button>
    </div>

</div>

<script>
    /**
     * éŠæˆ²æ ¸å¿ƒé‚è¼¯
     */
    
    // éŠæˆ²ç‹€æ…‹
    const state = {
        level: 1,
        maxLevels: 5,
        turn: 'PLAYER', // PLAYER, ENEMY
        ap: 3,
        maxAp: 3,
        shield: 0,
        playerStats: {
            hp: 100,
            maxHp: 100,
            atkBase: 0,
            startAp: 0
        },
        enemy: null
    };

    // æ•µäººè³‡æ–™åº«
    const enemyDatabase = [
        { name: "èœé³¥å¯¦ç¿’ç”Ÿ", hp: 60, atk: 8, icon: "ğŸ¤“", quotes: ["æˆ‘æ²’éŒ¢...", "æˆ‘è¦å•ä¸»ç®¡...", "çœŸçš„æœ‰å„ªæƒ å—ï¼Ÿ"] },
        { name: "æ–¤æ–¤è¨ˆè¼ƒå¤§å¬¸", hp: 100, atk: 12, icon: "ğŸ‘µ", quotes: ["éš”å£æ¯”è¼ƒä¾¿å®œè€¶", "é€å€‹è´ˆå“å•¦", "æˆ‘ä¸è²·äº†å–”ï¼"] },
        { name: "æš´èºç¸½ç¶“ç†", hp: 150, atk: 18, icon: "ğŸ˜ ", quotes: ["æˆ‘å¾ˆå¿™ï¼å¿«é»ï¼", "å«ä½ ç¶“ç†å‡ºä¾†ï¼", "é€™ä»€éº¼çˆ›ææ¡ˆï¼"] },
        { name: "å†·æ¼ å¯ŒäºŒä»£", hp: 200, atk: 15, icon: "ğŸ˜", quotes: ["å–”ã€‚", "æ²’èˆˆè¶£ã€‚", "æ‰€ä»¥å‘¢ï¼Ÿ"] },
        { name: "çµ‚æ¥µå¥§å®¢ç‹", hp: 300, atk: 25, icon: "ğŸ‘¹", quotes: ["æˆ‘è¦å®¢è¨´ä½ ï¼", "å»æ­»å§æ¥­å‹™å“¡ï¼", "æ¯€æ»…ä½ çš„æ¥­ç¸¾ï¼"] }
    ];

    // UI ç¶å®š
    const ui = {
        playerHpBar: document.getElementById('playerHpBar'),
        playerHpText: document.getElementById('playerHpText'),
        playerShieldBar: document.getElementById('playerShieldBar'),
        enemyHpBar: document.getElementById('enemyHpBar'),
        enemyHpText: document.getElementById('enemyHpText'),
        enemyName: document.getElementById('enemyName'),
        enemySprite: document.getElementById('enemySprite'),
        enemyBubble: document.getElementById('enemyBubble'),
        msgLog: document.getElementById('msgLog'),
        apText: document.getElementById('playerAp'),
        skillBtns: document.querySelectorAll('.skill-btn'),
        gameBoy: document.getElementById('game-boy'),
        
        startScreen: document.getElementById('startScreen'),
        upgradeScreen: document.getElementById('upgradeScreen'),
        endScreen: document.getElementById('endScreen'),
        victoryScreen: document.getElementById('victoryScreen')
    };

    /* --- ç³»çµ±åŠŸèƒ½ --- */

    function log(msg, color="#fff") {
        ui.msgLog.innerHTML = `<span style="color:${color}">${msg}</span>`;
        // ç°¡å–®çš„æ‰“å­—æ©Ÿæ•ˆæœé‡ç½®
        ui.msgLog.style.animation = 'none';
        ui.msgLog.offsetHeight; /* trigger reflow */
        ui.msgLog.style.animation = 'fadeIn 0.2s';
    }

    function updateUI() {
        // Player
        const hpPct = (state.playerStats.hp / state.playerStats.maxHp) * 100;
        ui.playerHpBar.style.width = `${Math.max(0, hpPct)}%`;
        ui.playerHpText.innerText = `${state.playerStats.hp}/${state.playerStats.maxHp}`;
        
        const shieldPct = Math.min(100, state.shield); // è­·ç›¾ç¤ºæ„
        ui.playerShieldBar.style.width = `${shieldPct}%`;

        ui.apText.innerText = state.ap;

        // Enemy
        if(state.enemy) {
            const eHPPct = (state.enemy.hp / state.enemy.maxHp) * 100;
            ui.enemyHpBar.style.width = `${Math.max(0, eHPPct)}%`;
            ui.enemyHpText.innerText = `${state.enemy.hp}/${state.enemy.maxHp}`;
        }

        // Buttons
        const costs = [1, 1, 2, 3]; // å°æ‡‰å››å€‹æŒ‰éˆ•çš„æ¶ˆè€—
        ui.skillBtns.forEach((btn, idx) => {
            btn.disabled = (state.turn !== 'PLAYER' || state.ap < costs[idx]);
        });
    }

    function spawnFloatingText(text, isCrit, targetSelector) {
        const el = document.createElement('div');
        el.className = 'damage-text';
        el.innerText = text;
        el.style.color = isCrit ? '#ff0000' : '#fff';
        if(!isCrit) el.style.fontSize = '24px';
        
        const target = document.querySelector(targetSelector);
        const rect = target.getBoundingClientRect();
        const containerRect = ui.gameBoy.getBoundingClientRect();
        
        el.style.left = (rect.left - containerRect.left + rect.width/2 - 20) + 'px';
        el.style.top = (rect.top - containerRect.top) + 'px';
        
        ui.gameBoy.appendChild(el);
        setTimeout(() => el.remove(), 800);
    }

    function shakeScreen() {
        ui.gameBoy.classList.add('shake-screen');
        setTimeout(() => ui.gameBoy.classList.remove('shake-screen'), 300);
    }

    /* --- éŠæˆ²æµç¨‹ --- */

    function startGame() {
        ui.startScreen.classList.add('hidden');
        resetPlayerStats();
        loadLevel(1);
    }

    function resetPlayerStats() {
        state.playerStats = { hp: 100, maxHp: 100, atkBase: 0, startAp: 0 };
    }

    function loadLevel(lvl) {
        state.level = lvl;
        state.ap = 3 + state.playerStats.startAp;
        state.shield = 0;
        state.turn = 'PLAYER';

        // è¼‰å…¥æ•µäºº
        const data = enemyDatabase[lvl - 1];
        state.enemy = {
            ...data,
            maxHp: data.hp
        };

        // UI åˆå§‹åŒ–
        ui.enemyName.innerText = `LV${lvl} ${state.enemy.name}`;
        ui.enemySprite.innerText = state.enemy.icon;
        
        updateUI();
        log(`é­é‡äº† ${state.enemy.name}ï¼`, "#00f3ff");
    }

    /* --- ç©å®¶å›åˆ --- */

    function useSkill(type) {
        if(state.turn !== 'PLAYER') return;

        let cost = 0;
        let msg = "";
        let dmg = 0;

        if (type === 'attack') {
            cost = 1;
            dmg = Math.floor(Math.random() * 6) + 15 + state.playerStats.atkBase; // 15-20
            state.enemy.hp -= dmg;
            msg = `ä½ ä½¿ç”¨äº†å¼·åŠ›æ¨éŠ·ï¼é€ æˆ ${dmg} é»èªªæœåŠ›ï¼`;
            spawnFloatingText(`-${dmg}`, false, '#enemySprite');
            
            // å‹•ç•«
            ui.enemySprite.style.transform = "scale(0.9)";
            setTimeout(()=>ui.enemySprite.style.transform = "scale(1)", 100);
        } 
        else if (type === 'defend') {
            cost = 1;
            state.shield += 15;
            msg = `ä½ å‡ç¬‘æ•·è¡ï¼ç²å¾— 15 é»å¿è€è­·ç›¾ã€‚`;
            spawnFloatingText(`+15 ç›¾`, false, '#playerSprite');
        }
        else if (type === 'heal') {
            cost = 2;
            const heal = 25;
            state.playerStats.hp = Math.min(state.playerStats.maxHp, state.playerStats.hp + heal);
            msg = `ä½ å–äº†å£å’–å•¡ï¼Œç†æ™ºæ¢å¾© ${heal} é»ï¼`;
            spawnFloatingText(`+${heal}`, false, '#playerSprite');
        }
        else if (type === 'ultimate') {
            cost = 3;
            dmg = Math.floor(Math.random() * 20) + 40 + state.playerStats.atkBase; // 40-60
            state.enemy.hp -= dmg;
            msg = `ç¥­å‡ºè·³æ¨“å¤§æ‹è³£ï¼é€ æˆ ${dmg} é»çˆ†æ“Šå‚·å®³ï¼`;
            spawnFloatingText(`CRITICAL -${dmg}`, true, '#enemySprite');
            shakeScreen();
        }

        state.ap -= cost;
        updateUI();
        log(msg);

        if (state.enemy.hp <= 0) {
            state.enemy.hp = 0;
            updateUI();
            setTimeout(winBattle, 1000);
        } else {
            // æª¢æŸ¥æ˜¯å¦é‚„æœ‰ APï¼Œè‹¥ç„¡å‰‡åˆ‡æ›å›åˆ
            // ç‚ºäº†ç°¡åŒ–ï¼Œé€™è£¡è¨­å®šæ¯æ¬¡è¡Œå‹•å¾Œå»¶é²ä¸€ä¸‹ï¼Œå¦‚æœç©å®¶æŒ‰äº†çµæŸå›åˆæŒ‰éˆ• (é€™è£¡ç°¡åŒ–ç‚ºè‡ªå‹•åˆ¤å®šæˆ–å¯ä»¥é€£çºŒè¡Œå‹•)
            // ç‚ºäº†ç­–ç•¥æ€§ï¼Œè®“ç©å®¶å¯ä»¥é€£çºŒè¡Œå‹•ç›´åˆ°æ²’ APï¼Œç„¶å¾Œè‡ªå‹•æ›æ•µäºº
            // ä½†ç‚ºäº†ç¯€å¥æ„Ÿï¼Œé€™è£¡è¨­è¨ˆï¼šè¡Œå‹•å¾Œï¼Œæª¢æŸ¥æ˜¯å¦è¦æ›äºº? ä¸ï¼Œè®“ç©å®¶è‡ªå·±æ±ºå®šé †åºï¼Œç›´åˆ°æ²’AP
            // ä¿®æ­£é‚è¼¯ï¼šå¦‚æœ AP æ­¸é›¶ï¼Œè‡ªå‹•æ›æ•µäººã€‚å¦‚æœé‚„æœ‰ APï¼Œç©å®¶å¯ç¹¼çºŒã€‚
            
            if (state.ap <= 0) {
                state.turn = 'ENEMY_WAIT'; // é˜²æ­¢é€£é»
                setTimeout(enemyTurn, 1000);
            }
        }
    }

    /* --- æ•µäººå›åˆ --- */

    function enemyTurn() {
        state.turn = 'ENEMY';
        log(`${state.enemy.name} æ­£åœ¨æ€è€ƒåˆé›£ä½ çš„ç†ç”±...`, "#ff4d4d");

        // éš¨æ©Ÿèªªè©±
        const quote = state.enemy.quotes[Math.floor(Math.random() * state.enemy.quotes.length)];
        ui.enemyBubble.innerText = quote;
        ui.enemyBubble.classList.add('show');

        setTimeout(() => {
            ui.enemyBubble.classList.remove('show');
            
            // æ”»æ“Šè¨ˆç®—
            let dmg = state.enemy.atk + Math.floor(Math.random() * 5); // æµ®å‹•å‚·å®³
            
            // è­·ç›¾æŠµæ“‹
            if (state.shield > 0) {
                if (state.shield >= dmg) {
                    state.shield -= dmg;
                    dmg = 0;
                    log("ä½ çš„å‡ç¬‘å®Œå…¨é˜²ç¦¦äº†å¥§å®¢çš„æ”»æ“Šï¼", "#f9d71c");
                } else {
                    dmg -= state.shield;
                    state.shield = 0;
                    log("è­·ç›¾ç ´è£‚ï¼ä½ å—åˆ°äº†ç²¾ç¥å‚·å®³ï¼", "#ff4d4d");
                }
            } else {
                log(`å¥§å®¢ç™¼å‹•è¨€èªæ”»æ“Šï¼ç†æ™º -${dmg}`, "#ff4d4d");
            }

            if (dmg > 0) {
                state.playerStats.hp -= dmg;
                spawnFloatingText(`-${dmg}`, true, '#playerSprite');
                shakeScreen();
            }

            updateUI();

            if (state.playerStats.hp <= 0) {
                setTimeout(loseBattle, 1000);
            } else {
                // å›åˆ°ç©å®¶å›åˆ
                setTimeout(() => {
                    state.turn = 'PLAYER';
                    state.ap = Math.min(state.maxAp, state.ap + 3 + state.playerStats.startAp); // æ¯å›åˆå›æ»¿ 3 AP
                    // state.shield = 0; // è­·ç›¾æ˜¯å¦ä¿ç•™ï¼Ÿä¿ç•™æ¯”è¼ƒå¥½ç©
                    log("è¼ªåˆ°ä½ äº†ï¼è«‹é¸æ“‡å°ç­–ã€‚", "#00ff88");
                    updateUI();
                }, 1000);
            }

        }, 1500);
    }

    /* --- çµç®— --- */

    function winBattle() {
        if (state.level >= state.maxLevels) {
            ui.victoryScreen.classList.remove('hidden');
        } else {
            ui.upgradeScreen.classList.remove('hidden');
        }
    }

    function loseBattle() {
        ui.endScreen.classList.remove('hidden');
    }

    function applyUpgrade(type) {
        if (type === 'atk') {
            state.playerStats.atkBase += 5;
        } else if (type === 'hp') {
            state.playerStats.maxHp += 20;
            state.playerStats.hp = state.playerStats.maxHp; // è£œæ»¿
        } else if (type === 'ap') {
            state.playerStats.startAp += 1;
        }
        
        ui.upgradeScreen.classList.add('hidden');
        loadLevel(state.level + 1);
    }

    function resetGame() {
        ui.endScreen.classList.add('hidden');
        ui.victoryScreen.classList.add('hidden');
        startGame();
    }

</script>
</body>
</html>